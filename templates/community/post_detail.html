{% extends "base.html" %}
{% block title %}{{ post.title }} - L7*7 ì»¤ë®¤ë‹ˆí‹°{% endblock %}

{% block content %}
<section class="pt-24 pb-16 px-4 min-h-screen">
    <div class="max-w-3xl mx-auto">
        <!-- ìƒë‹¨ ë„¤ë¹„ -->
        <div class="mb-4">
            <a href="{% url 'community:post_list' post.board.slug %}" class="text-white/40 hover:text-white text-sm">
                &larr; {{ post.board.icon }} {{ post.board.name }}
            </a>
        </div>

        <!-- ê²Œì‹œê¸€ -->
        <div class="glass-card rounded-2xl p-6 mb-4">
            <h1 class="text-xl font-bold mb-3">{{ post.title }}</h1>
            <div class="flex items-center justify-between text-xs text-white/40 mb-4 pb-4 border-b border-white/10">
                <div class="flex items-center gap-3">
                    <span class="text-lotto-gold">{{ post.author.profile.nickname|default:post.author.username }}</span>
                    <span>{{ post.created_at|date:"Y.m.d H:i" }}</span>
                    <span>ì¡°íšŒ {{ post.views }}</span>
                </div>
                {% if user == post.author %}
                <div class="flex gap-2">
                    <a href="{% url 'community:post_update' post.pk %}" class="hover:text-white">ìˆ˜ì •</a>
                    <a href="{% url 'community:post_delete' post.pk %}" class="hover:text-red-400">ì‚­ì œ</a>
                </div>
                {% endif %}
            </div>
            <div class="text-sm text-white/80 leading-relaxed whitespace-pre-wrap">{{ post.content }}</div>

            <!-- ì¢‹ì•„ìš” -->
            <div class="mt-6 pt-4 border-t border-white/10 flex items-center gap-2">
                <button id="like-btn" onclick="toggleLike({{ post.pk }})"
                    class="flex items-center gap-1.5 px-4 py-2 rounded-full text-sm transition-all
                    {% if user_liked %}bg-red-500/20 text-red-400 border border-red-500/30{% else %}bg-white/5 text-white/40 border border-white/10 hover:bg-white/10{% endif %}">
                    <span id="like-icon">{% if user_liked %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                    <span id="like-count">{{ post.like_count }}</span>
                </button>
            </div>
        </div>

        <!-- ëŒ“ê¸€ -->
        <div class="glass-card rounded-2xl p-6">
            <h3 class="font-bold text-sm mb-4">ëŒ“ê¸€ {{ comments|length }}ê°œ</h3>

            {% for comment in comments %}
            <div class="py-3 border-b border-white/5 last:border-0">
                <div class="flex items-center gap-2 mb-1 text-xs">
                    <span class="text-lotto-gold">{{ comment.author.profile.nickname|default:comment.author.username }}</span>
                    <span class="text-white/30">{{ comment.created_at|date:"m/d H:i" }}</span>
                </div>
                <p class="text-sm text-white/70">{{ comment.content }}</p>
            </div>
            {% empty %}
            <p class="text-white/30 text-sm py-2">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endfor %}

            {% if user.is_authenticated %}
            <form method="post" action="{% url 'community:comment_create' post.pk %}" class="mt-4 pt-4 border-t border-white/10">
                {% csrf_token %}
                {{ comment_form.content }}
                <button type="submit"
                    class="mt-2 px-4 py-2 bg-lotto-gold/20 border border-lotto-gold/40 text-lotto-gold text-sm rounded-lg hover:bg-lotto-gold/30 transition-all">
                    ëŒ“ê¸€ ì‘ì„±
                </button>
            </form>
            {% else %}
            <p class="text-white/30 text-xs mt-4 pt-4 border-t border-white/10">
                <a href="{% url 'accounts:login' %}" class="text-lotto-gold hover:underline">ë¡œê·¸ì¸</a> í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
async function toggleLike(postId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value
        || '{{ csrf_token }}';
    const res = await fetch(`/community/post/${postId}/like/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
    });
    if (!res.ok) {
        if (res.status === 403) window.location.href = '{% url "accounts:login" %}';
        return;
    }
    const data = await res.json();
    const btn = document.getElementById('like-btn');
    document.getElementById('like-icon').textContent = data.liked ? 'â¤ï¸' : 'ğŸ¤';
    document.getElementById('like-count').textContent = data.count;
    if (data.liked) {
        btn.className = btn.className.replace('bg-white/5 text-white/40 border-white/10 hover:bg-white/10', 'bg-red-500/20 text-red-400 border-red-500/30');
    } else {
        btn.className = btn.className.replace('bg-red-500/20 text-red-400 border-red-500/30', 'bg-white/5 text-white/40 border-white/10 hover:bg-white/10');
    }
}
</script>
{% endblock %}
